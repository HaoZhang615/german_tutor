{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "14515754688663656683"
    }
  },
  "parameters": {
    "environmentName": {
      "type": "string",
      "minLength": 1,
      "maxLength": 64,
      "metadata": {
        "description": "Name of the environment (e.g., dev, staging, prod)"
      }
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "Primary location for all resources (must support gpt-realtime and gpt-4o-mini-tts models for Azure OpenAI, e.g., eastus2)"
      }
    },
    "containerRegistryName": {
      "type": "string",
      "defaultValue": ""
    },
    "logAnalyticsName": {
      "type": "string",
      "defaultValue": ""
    },
    "applicationInsightsName": {
      "type": "string",
      "defaultValue": ""
    },
    "googleClientId": {
      "type": "securestring",
      "defaultValue": ""
    },
    "googleClientSecret": {
      "type": "securestring",
      "defaultValue": ""
    },
    "githubClientId": {
      "type": "securestring",
      "defaultValue": ""
    },
    "githubClientSecret": {
      "type": "securestring",
      "defaultValue": ""
    },
    "jwtSecretKey": {
      "type": "securestring",
      "defaultValue": ""
    },
    "jwtAlgorithm": {
      "type": "string",
      "defaultValue": "HS256"
    },
    "jwtAccessTokenExpireMinutes": {
      "type": "int",
      "defaultValue": 60
    },
    "jwtRefreshTokenExpireDays": {
      "type": "int",
      "defaultValue": 7
    },
    "smtpHost": {
      "type": "string",
      "defaultValue": ""
    },
    "smtpPort": {
      "type": "int",
      "defaultValue": 587
    },
    "smtpUser": {
      "type": "string",
      "defaultValue": ""
    },
    "smtpPassword": {
      "type": "securestring",
      "defaultValue": ""
    },
    "smtpFromEmail": {
      "type": "string",
      "defaultValue": ""
    },
    "smtpFromName": {
      "type": "string",
      "defaultValue": "German Tutor"
    },
    "smtpUseTls": {
      "type": "string",
      "defaultValue": "true"
    },
    "verificationTokenExpireHours": {
      "type": "int",
      "defaultValue": 24
    },
    "passwordResetTokenExpireHours": {
      "type": "int",
      "defaultValue": 1
    },
    "frontendUrl": {
      "type": "string",
      "defaultValue": ""
    }
  },
  "variables": {
    "$fxv#0": {
      "analyticsWorkspaces": "log-",
      "appManagedEnvironments": "cae-",
      "cognitiveServicesAccounts": "cog-",
      "containerApps": "ca-",
      "containerRegistryRegistries": "cr",
      "insightsComponents": "appi-",
      "keyVaultVaults": "kv-",
      "managedIdentityUserAssignedIdentities": "id-",
      "operationalInsightsWorkspaces": "log-",
      "webStaticSites": "stapp-"
    },
    "abbrs": "[variables('$fxv#0')]",
    "resourceToken": "[toLower(uniqueString(subscription().id, parameters('environmentName'), parameters('location')))]",
    "tags": {
      "azd-env-name": "[parameters('environmentName')]",
      "application": "german-tutor"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2024-03-01",
      "name": "[format('rg-{0}', parameters('environmentName'))]",
      "location": "[parameters('location')]",
      "tags": "[variables('tags')]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "monitoring",
      "resourceGroup": "[format('rg-{0}', parameters('environmentName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "logAnalyticsName": "[if(not(empty(parameters('logAnalyticsName'))), createObject('value', parameters('logAnalyticsName')), createObject('value', format('{0}{1}', variables('abbrs').operationalInsightsWorkspaces, variables('resourceToken'))))]",
          "applicationInsightsName": "[if(not(empty(parameters('applicationInsightsName'))), createObject('value', parameters('applicationInsightsName')), createObject('value', format('{0}{1}', variables('abbrs').insightsComponents, variables('resourceToken'))))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "3494697464587482114"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "logAnalyticsName": {
              "type": "string"
            },
            "applicationInsightsName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2023-09-01",
              "name": "[parameters('logAnalyticsName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 30
              }
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('applicationInsightsName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]"
              ]
            }
          ],
          "outputs": {
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]"
            },
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "value": "[parameters('logAnalyticsName')]"
            },
            "applicationInsightsId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/components', parameters('applicationInsightsName'))]"
            },
            "applicationInsightsName": {
              "type": "string",
              "value": "[parameters('applicationInsightsName')]"
            },
            "applicationInsightsConnectionString": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('applicationInsightsName')), '2020-02-02').ConnectionString]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-{0}', parameters('environmentName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "backend-identity",
      "resourceGroup": "[format('rg-{0}', parameters('environmentName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "name": {
            "value": "[format('id-backend-{0}', variables('resourceToken'))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "11311845526480116006"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "name": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name')), '2023-01-31').principalId]"
            },
            "clientId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name')), '2023-01-31').clientId]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-{0}', parameters('environmentName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "openai",
      "resourceGroup": "[format('rg-{0}', parameters('environmentName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "name": {
            "value": "[format('{0}{1}', variables('abbrs').cognitiveServicesAccounts, variables('resourceToken'))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "16948260366063943193"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "name": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2024-06-01-preview",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "OpenAI",
              "sku": {
                "name": "S0"
              },
              "properties": {
                "customSubDomainName": "[toLower(parameters('name'))]",
                "publicNetworkAccess": "Enabled",
                "networkAcls": {
                  "defaultAction": "Allow"
                }
              }
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2024-06-01-preview",
              "name": "[format('{0}/{1}', parameters('name'), 'gpt-realtime')]",
              "sku": {
                "name": "GlobalStandard",
                "capacity": 5
              },
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "gpt-realtime",
                  "version": "2025-08-28"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2024-06-01-preview",
              "name": "[format('{0}/{1}', parameters('name'), 'gpt-4o-mini-tts')]",
              "sku": {
                "name": "GlobalStandard",
                "capacity": 5
              },
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "gpt-4o-mini-tts",
                  "version": "2025-03-20"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]",
                "[resourceId('Microsoft.CognitiveServices/accounts/deployments', parameters('name'), 'gpt-realtime')]"
              ]
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "endpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('name')), '2024-06-01-preview').endpoint]"
            },
            "realtimeDeploymentName": {
              "type": "string",
              "value": "gpt-realtime"
            },
            "ttsDeploymentName": {
              "type": "string",
              "value": "gpt-4o-mini-tts"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-{0}', parameters('environmentName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "container-apps",
      "resourceGroup": "[format('rg-{0}', parameters('environmentName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "environmentName": {
            "value": "[format('{0}{1}', variables('abbrs').appManagedEnvironments, variables('resourceToken'))]"
          },
          "containerRegistryName": "[if(not(empty(parameters('containerRegistryName'))), createObject('value', parameters('containerRegistryName')), createObject('value', format('{0}{1}', variables('abbrs').containerRegistryRegistries, variables('resourceToken'))))]",
          "logAnalyticsWorkspaceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'monitoring'), '2025-04-01').outputs.logAnalyticsWorkspaceId.value]"
          },
          "applicationInsightsConnectionString": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'monitoring'), '2025-04-01').outputs.applicationInsightsConnectionString.value]"
          },
          "openAiEndpoint": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'openai'), '2025-04-01').outputs.endpoint.value]"
          },
          "openAiResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'openai'), '2025-04-01').outputs.id.value]"
          },
          "realtimeDeploymentName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'openai'), '2025-04-01').outputs.realtimeDeploymentName.value]"
          },
          "ttsDeploymentName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'openai'), '2025-04-01').outputs.ttsDeploymentName.value]"
          },
          "cosmosDbEndpoint": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'cosmosdb'), '2025-04-01').outputs.endpoint.value]"
          },
          "cosmosDbDatabase": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'cosmosdb'), '2025-04-01').outputs.databaseName.value]"
          },
          "cosmosDbConversationsContainer": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'cosmosdb'), '2025-04-01').outputs.conversationsContainerName.value]"
          },
          "backendIdentityId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'backend-identity'), '2025-04-01').outputs.id.value]"
          },
          "backendIdentityClientId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'backend-identity'), '2025-04-01').outputs.clientId.value]"
          },
          "backendIdentityPrincipalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'backend-identity'), '2025-04-01').outputs.principalId.value]"
          },
          "frontendUrl": "[if(not(empty(parameters('frontendUrl'))), createObject('value', parameters('frontendUrl')), createObject('value', 'https://placeholder.azurestaticapps.net'))]",
          "googleClientId": {
            "value": "[parameters('googleClientId')]"
          },
          "googleClientSecret": {
            "value": "[parameters('googleClientSecret')]"
          },
          "githubClientId": {
            "value": "[parameters('githubClientId')]"
          },
          "githubClientSecret": {
            "value": "[parameters('githubClientSecret')]"
          },
          "jwtSecretKey": {
            "value": "[parameters('jwtSecretKey')]"
          },
          "jwtAlgorithm": {
            "value": "[parameters('jwtAlgorithm')]"
          },
          "jwtAccessTokenExpireMinutes": {
            "value": "[parameters('jwtAccessTokenExpireMinutes')]"
          },
          "jwtRefreshTokenExpireDays": {
            "value": "[parameters('jwtRefreshTokenExpireDays')]"
          },
          "smtpHost": {
            "value": "[parameters('smtpHost')]"
          },
          "smtpPort": {
            "value": "[parameters('smtpPort')]"
          },
          "smtpUser": {
            "value": "[parameters('smtpUser')]"
          },
          "smtpPassword": {
            "value": "[parameters('smtpPassword')]"
          },
          "smtpFromEmail": {
            "value": "[parameters('smtpFromEmail')]"
          },
          "smtpFromName": {
            "value": "[parameters('smtpFromName')]"
          },
          "smtpUseTls": {
            "value": "[parameters('smtpUseTls')]"
          },
          "verificationTokenExpireHours": {
            "value": "[parameters('verificationTokenExpireHours')]"
          },
          "passwordResetTokenExpireHours": {
            "value": "[parameters('passwordResetTokenExpireHours')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "5190931030660344889"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "environmentName": {
              "type": "string"
            },
            "containerRegistryName": {
              "type": "string"
            },
            "logAnalyticsWorkspaceId": {
              "type": "string"
            },
            "applicationInsightsConnectionString": {
              "type": "string"
            },
            "openAiEndpoint": {
              "type": "string"
            },
            "openAiResourceId": {
              "type": "string"
            },
            "realtimeDeploymentName": {
              "type": "string"
            },
            "ttsDeploymentName": {
              "type": "string"
            },
            "cosmosDbEndpoint": {
              "type": "string",
              "defaultValue": ""
            },
            "cosmosDbDatabase": {
              "type": "string",
              "defaultValue": ""
            },
            "cosmosDbConversationsContainer": {
              "type": "string",
              "defaultValue": ""
            },
            "backendIdentityId": {
              "type": "string"
            },
            "backendIdentityClientId": {
              "type": "string"
            },
            "backendIdentityPrincipalId": {
              "type": "string"
            },
            "frontendUrl": {
              "type": "string"
            },
            "googleClientId": {
              "type": "securestring",
              "defaultValue": ""
            },
            "googleClientSecret": {
              "type": "securestring",
              "defaultValue": ""
            },
            "githubClientId": {
              "type": "securestring",
              "defaultValue": ""
            },
            "githubClientSecret": {
              "type": "securestring",
              "defaultValue": ""
            },
            "jwtSecretKey": {
              "type": "securestring",
              "defaultValue": ""
            },
            "jwtAlgorithm": {
              "type": "string",
              "defaultValue": "HS256"
            },
            "jwtAccessTokenExpireMinutes": {
              "type": "int",
              "defaultValue": 60
            },
            "jwtRefreshTokenExpireDays": {
              "type": "int",
              "defaultValue": 7
            },
            "smtpHost": {
              "type": "string",
              "defaultValue": ""
            },
            "smtpPort": {
              "type": "int",
              "defaultValue": 587
            },
            "smtpUser": {
              "type": "string",
              "defaultValue": ""
            },
            "smtpPassword": {
              "type": "securestring",
              "defaultValue": ""
            },
            "smtpFromEmail": {
              "type": "string",
              "defaultValue": ""
            },
            "smtpFromName": {
              "type": "string",
              "defaultValue": "German Tutor"
            },
            "smtpUseTls": {
              "type": "string",
              "defaultValue": "true"
            },
            "verificationTokenExpireHours": {
              "type": "int",
              "defaultValue": 24
            },
            "passwordResetTokenExpireHours": {
              "type": "int",
              "defaultValue": 1
            }
          },
          "resources": [
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2023-11-01-preview",
              "name": "[replace(parameters('containerRegistryName'), '-', '')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Basic"
              },
              "properties": {
                "adminUserEnabled": true
              }
            },
            {
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2024-03-01",
              "name": "[parameters('environmentName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "appLogsConfiguration": {
                  "destination": "log-analytics",
                  "logAnalyticsConfiguration": {
                    "customerId": "[reference(parameters('logAnalyticsWorkspaceId'), '2023-09-01').customerId]",
                    "sharedKey": "[listKeys(parameters('logAnalyticsWorkspaceId'), '2023-09-01').primarySharedKey]"
                  }
                }
              }
            },
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2024-03-01",
              "name": "ca-backend",
              "location": "[parameters('location')]",
              "tags": "[union(parameters('tags'), createObject('azd-service-name', 'backend'))]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('backendIdentityId'))]": {}
                }
              },
              "properties": {
                "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', parameters('environmentName'))]",
                "configuration": {
                  "activeRevisionsMode": "Single",
                  "ingress": {
                    "external": true,
                    "targetPort": 8000,
                    "transport": "http",
                    "corsPolicy": {
                      "allowedOrigins": [
                        "*"
                      ],
                      "allowedMethods": [
                        "GET",
                        "POST",
                        "PUT",
                        "DELETE",
                        "OPTIONS"
                      ],
                      "allowedHeaders": [
                        "*"
                      ]
                    }
                  },
                  "registries": [
                    {
                      "server": "[reference(resourceId('Microsoft.ContainerRegistry/registries', replace(parameters('containerRegistryName'), '-', '')), '2023-11-01-preview').loginServer]",
                      "username": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', replace(parameters('containerRegistryName'), '-', '')), '2023-11-01-preview').username]",
                      "passwordSecretRef": "registry-password"
                    }
                  ],
                  "secrets": [
                    {
                      "name": "registry-password",
                      "value": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', replace(parameters('containerRegistryName'), '-', '')), '2023-11-01-preview').passwords[0].value]"
                    },
                    {
                      "name": "google-client-id",
                      "value": "[parameters('googleClientId')]"
                    },
                    {
                      "name": "google-client-secret",
                      "value": "[parameters('googleClientSecret')]"
                    },
                    {
                      "name": "github-client-id",
                      "value": "[parameters('githubClientId')]"
                    },
                    {
                      "name": "github-client-secret",
                      "value": "[parameters('githubClientSecret')]"
                    },
                    {
                      "name": "jwt-secret-key",
                      "value": "[parameters('jwtSecretKey')]"
                    },
                    {
                      "name": "smtp-password",
                      "value": "[parameters('smtpPassword')]"
                    }
                  ]
                },
                "template": {
                  "containers": [
                    {
                      "name": "backend",
                      "image": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
                      "resources": {
                        "cpu": "[json('0.5')]",
                        "memory": "1Gi"
                      },
                      "env": [
                        {
                          "name": "AZURE_OPENAI_ENDPOINT",
                          "value": "[parameters('openAiEndpoint')]"
                        },
                        {
                          "name": "AZURE_OPENAI_REALTIME_DEPLOYMENT",
                          "value": "[parameters('realtimeDeploymentName')]"
                        },
                        {
                          "name": "AZURE_OPENAI_TTS_DEPLOYMENT",
                          "value": "[parameters('ttsDeploymentName')]"
                        },
                        {
                          "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                          "value": "[parameters('applicationInsightsConnectionString')]"
                        },
                        {
                          "name": "AZURE_CLIENT_ID",
                          "value": "[parameters('backendIdentityClientId')]"
                        },
                        {
                          "name": "CORS_ORIGINS",
                          "value": "*"
                        },
                        {
                          "name": "COSMOSDB_ENDPOINT",
                          "value": "[parameters('cosmosDbEndpoint')]"
                        },
                        {
                          "name": "COSMOSDB_DATABASE",
                          "value": "[parameters('cosmosDbDatabase')]"
                        },
                        {
                          "name": "COSMOSDB_CONVERSATIONS_CONTAINER",
                          "value": "[parameters('cosmosDbConversationsContainer')]"
                        },
                        {
                          "name": "FRONTEND_URL",
                          "value": "[parameters('frontendUrl')]"
                        },
                        {
                          "name": "GOOGLE_CLIENT_ID",
                          "secretRef": "google-client-id"
                        },
                        {
                          "name": "GOOGLE_CLIENT_SECRET",
                          "secretRef": "google-client-secret"
                        },
                        {
                          "name": "GITHUB_CLIENT_ID",
                          "secretRef": "github-client-id"
                        },
                        {
                          "name": "GITHUB_CLIENT_SECRET",
                          "secretRef": "github-client-secret"
                        },
                        {
                          "name": "JWT_SECRET_KEY",
                          "secretRef": "jwt-secret-key"
                        },
                        {
                          "name": "JWT_ALGORITHM",
                          "value": "[parameters('jwtAlgorithm')]"
                        },
                        {
                          "name": "JWT_ACCESS_TOKEN_EXPIRE_MINUTES",
                          "value": "[string(parameters('jwtAccessTokenExpireMinutes'))]"
                        },
                        {
                          "name": "JWT_REFRESH_TOKEN_EXPIRE_DAYS",
                          "value": "[string(parameters('jwtRefreshTokenExpireDays'))]"
                        },
                        {
                          "name": "SMTP_HOST",
                          "value": "[parameters('smtpHost')]"
                        },
                        {
                          "name": "SMTP_PORT",
                          "value": "[string(parameters('smtpPort'))]"
                        },
                        {
                          "name": "SMTP_USER",
                          "value": "[parameters('smtpUser')]"
                        },
                        {
                          "name": "SMTP_PASSWORD",
                          "secretRef": "smtp-password"
                        },
                        {
                          "name": "SMTP_FROM_EMAIL",
                          "value": "[parameters('smtpFromEmail')]"
                        },
                        {
                          "name": "SMTP_FROM_NAME",
                          "value": "[parameters('smtpFromName')]"
                        },
                        {
                          "name": "SMTP_USE_TLS",
                          "value": "[parameters('smtpUseTls')]"
                        },
                        {
                          "name": "VERIFICATION_TOKEN_EXPIRE_HOURS",
                          "value": "[string(parameters('verificationTokenExpireHours'))]"
                        },
                        {
                          "name": "PASSWORD_RESET_TOKEN_EXPIRE_HOURS",
                          "value": "[string(parameters('passwordResetTokenExpireHours'))]"
                        }
                      ]
                    }
                  ],
                  "scale": {
                    "minReplicas": 0,
                    "maxReplicas": 5,
                    "rules": [
                      {
                        "name": "http-scaling",
                        "http": {
                          "metadata": {
                            "concurrentRequests": "10"
                          }
                        }
                      }
                    ]
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.App/managedEnvironments', parameters('environmentName'))]",
                "[resourceId('Microsoft.ContainerRegistry/registries', replace(parameters('containerRegistryName'), '-', ''))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', last(split(parameters('openAiResourceId'), '/')))]",
              "name": "[guid(parameters('openAiResourceId'), parameters('backendIdentityId'), 'Cognitive Services OpenAI User')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '5e0bd9bd-7b93-4f28-af87-19fc36ad61bd')]",
                "principalId": "[parameters('backendIdentityPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ],
          "outputs": {
            "environmentName": {
              "type": "string",
              "value": "[parameters('environmentName')]"
            },
            "environmentId": {
              "type": "string",
              "value": "[resourceId('Microsoft.App/managedEnvironments', parameters('environmentName'))]"
            },
            "containerRegistryEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', replace(parameters('containerRegistryName'), '-', '')), '2023-11-01-preview').loginServer]"
            },
            "containerRegistryName": {
              "type": "string",
              "value": "[replace(parameters('containerRegistryName'), '-', '')]"
            },
            "backendUrl": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.App/containerApps', 'ca-backend'), '2024-03-01').configuration.ingress.fqdn)]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'backend-identity')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'cosmosdb')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'monitoring')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'openai')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-{0}', parameters('environmentName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "cosmosdb",
      "resourceGroup": "[format('rg-{0}', parameters('environmentName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "name": {
            "value": "[format('cosmos-{0}', variables('resourceToken'))]"
          },
          "backendIdentityPrincipalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'backend-identity'), '2025-04-01').outputs.principalId.value]"
          },
          "backendIdentityName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'backend-identity'), '2025-04-01').outputs.name.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "459198144816172098"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "name": {
              "type": "string"
            },
            "databaseName": {
              "type": "string",
              "defaultValue": "GermanTutor"
            },
            "backendIdentityPrincipalId": {
              "type": "string"
            },
            "backendIdentityName": {
              "type": "string"
            }
          },
          "variables": {
            "cosmosDataContributor": "00000000-0000-0000-0000-000000000002"
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/databaseAccounts",
              "apiVersion": "2024-05-15",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "GlobalDocumentDB",
              "properties": {
                "databaseAccountOfferType": "Standard",
                "locations": [
                  {
                    "locationName": "[parameters('location')]",
                    "failoverPriority": 0,
                    "isZoneRedundant": false
                  }
                ],
                "consistencyPolicy": {
                  "defaultConsistencyLevel": "Session"
                },
                "capabilities": [
                  {
                    "name": "EnableServerless"
                  }
                ],
                "publicNetworkAccess": "Enabled"
              }
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
              "apiVersion": "2024-05-15",
              "name": "[format('{0}/{1}', parameters('name'), parameters('databaseName'))]",
              "properties": {
                "resource": {
                  "id": "[parameters('databaseName')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
              "apiVersion": "2024-05-15",
              "name": "[format('{0}/{1}/{2}', parameters('name'), parameters('databaseName'), 'Conversations')]",
              "properties": {
                "resource": {
                  "id": "Conversations",
                  "partitionKey": {
                    "kind": "Hash",
                    "paths": [
                      "/session_id"
                    ]
                  },
                  "indexingPolicy": {
                    "indexingMode": "consistent",
                    "includedPaths": [
                      {
                        "path": "/*"
                      }
                    ],
                    "excludedPaths": [
                      {
                        "path": "/\"_etag\"/?"
                      }
                    ]
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('name'), parameters('databaseName'))]"
              ]
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
              "apiVersion": "2024-05-15",
              "name": "[format('{0}/{1}/{2}', parameters('name'), parameters('databaseName'), 'Users')]",
              "properties": {
                "resource": {
                  "id": "Users",
                  "partitionKey": {
                    "kind": "Hash",
                    "paths": [
                      "/email"
                    ]
                  },
                  "indexingPolicy": {
                    "indexingMode": "consistent",
                    "includedPaths": [
                      {
                        "path": "/*"
                      }
                    ],
                    "excludedPaths": [
                      {
                        "path": "/\"_etag\"/?"
                      }
                    ]
                  },
                  "uniqueKeyPolicy": {
                    "uniqueKeys": [
                      {
                        "paths": [
                          "/email"
                        ]
                      }
                    ]
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('name'), parameters('databaseName'))]"
              ]
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
              "apiVersion": "2024-05-15",
              "name": "[format('{0}/{1}/{2}', parameters('name'), parameters('databaseName'), 'UserProgress')]",
              "properties": {
                "resource": {
                  "id": "UserProgress",
                  "partitionKey": {
                    "kind": "Hash",
                    "paths": [
                      "/user_id"
                    ]
                  },
                  "indexingPolicy": {
                    "indexingMode": "consistent",
                    "includedPaths": [
                      {
                        "path": "/*"
                      }
                    ],
                    "excludedPaths": [
                      {
                        "path": "/\"_etag\"/?"
                      }
                    ]
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('name'), parameters('databaseName'))]"
              ]
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
              "apiVersion": "2021-04-15",
              "name": "[format('{0}/{1}', parameters('name'), guid(variables('cosmosDataContributor'), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('backendIdentityName')), resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('name'))))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions', parameters('name'), variables('cosmosDataContributor'))]",
                "principalId": "[parameters('backendIdentityPrincipalId')]",
                "scope": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('name'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "endpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('name')), '2024-05-15').documentEndpoint]"
            },
            "databaseName": {
              "type": "string",
              "value": "[parameters('databaseName')]"
            },
            "conversationsContainerName": {
              "type": "string",
              "value": "Conversations"
            },
            "usersContainerName": {
              "type": "string",
              "value": "Users"
            },
            "userProgressContainerName": {
              "type": "string",
              "value": "UserProgress"
            },
            "accountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('name'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'backend-identity')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-{0}', parameters('environmentName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "static-web-app",
      "resourceGroup": "[format('rg-{0}', parameters('environmentName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "name": {
            "value": "[format('{0}{1}', variables('abbrs').webStaticSites, variables('resourceToken'))]"
          },
          "backendUrl": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'container-apps'), '2025-04-01').outputs.backendUrl.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "14162002511040647053"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "name": {
              "type": "string"
            },
            "backendUrl": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/staticSites",
              "apiVersion": "2023-12-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[union(parameters('tags'), createObject('azd-service-name', 'frontend'))]",
              "sku": {
                "name": "Free",
                "tier": "Free"
              },
              "properties": {
                "stagingEnvironmentPolicy": "Enabled",
                "allowConfigFileUpdates": true,
                "buildProperties": {
                  "appLocation": "src/frontend",
                  "outputLocation": "dist",
                  "appBuildCommand": "npm run build"
                }
              }
            },
            {
              "type": "Microsoft.Web/staticSites/config",
              "apiVersion": "2023-12-01",
              "name": "[format('{0}/{1}', parameters('name'), 'appsettings')]",
              "properties": {
                "VITE_API_URL": "[parameters('backendUrl')]",
                "VITE_WS_URL": "[replace(parameters('backendUrl'), 'https://', 'wss://')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/staticSites', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/staticSites', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "url": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/staticSites', parameters('name')), '2023-12-01').defaultHostname)]"
            },
            "deploymentToken": {
              "type": "string",
              "value": "[listSecrets(resourceId('Microsoft.Web/staticSites', parameters('name')), '2023-12-01').properties.apiKey]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'container-apps')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-{0}', parameters('environmentName')))]"
      ]
    }
  ],
  "outputs": {
    "AZURE_LOCATION": {
      "type": "string",
      "value": "[parameters('location')]"
    },
    "AZURE_TENANT_ID": {
      "type": "string",
      "value": "[tenant().tenantId]"
    },
    "AZURE_RESOURCE_GROUP": {
      "type": "string",
      "value": "[format('rg-{0}', parameters('environmentName'))]"
    },
    "AZURE_OPENAI_ENDPOINT": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'openai'), '2025-04-01').outputs.endpoint.value]"
    },
    "AZURE_OPENAI_REALTIME_DEPLOYMENT": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'openai'), '2025-04-01').outputs.realtimeDeploymentName.value]"
    },
    "AZURE_OPENAI_TTS_DEPLOYMENT": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'openai'), '2025-04-01').outputs.ttsDeploymentName.value]"
    },
    "AZURE_CONTAINER_REGISTRY_ENDPOINT": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'container-apps'), '2025-04-01').outputs.containerRegistryEndpoint.value]"
    },
    "AZURE_CONTAINER_REGISTRY_NAME": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'container-apps'), '2025-04-01').outputs.containerRegistryName.value]"
    },
    "AZURE_CONTAINER_APPS_ENVIRONMENT_NAME": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'container-apps'), '2025-04-01').outputs.environmentName.value]"
    },
    "BACKEND_URL": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'container-apps'), '2025-04-01').outputs.backendUrl.value]"
    },
    "FRONTEND_URL": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'static-web-app'), '2025-04-01').outputs.url.value]"
    },
    "COSMOSDB_ENDPOINT": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'cosmosdb'), '2025-04-01').outputs.endpoint.value]"
    },
    "COSMOSDB_DATABASE": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'cosmosdb'), '2025-04-01').outputs.databaseName.value]"
    },
    "COSMOSDB_CONVERSATIONS_CONTAINER": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}', parameters('environmentName'))), 'Microsoft.Resources/deployments', 'cosmosdb'), '2025-04-01').outputs.conversationsContainerName.value]"
    }
  }
}